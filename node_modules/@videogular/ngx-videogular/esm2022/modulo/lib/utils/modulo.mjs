const AudioContext = window["AudioContext"] || window["webkitAudioContext"];
export class Gondolo {
    constructor(audio, ctx, opts) {
        if (!(this instanceof Gondolo)) {
            return new Gondolo(audio, ctx, opts);
        }
        if (!(ctx instanceof AudioContext)) {
            (opts = ctx), (ctx = null);
        }
        opts = opts || {};
        this.ctx = ctx = ctx || new AudioContext();
        if (!(audio instanceof AudioNode)) {
            audio =
                audio instanceof Audio || audio instanceof HTMLAudioElement
                    ? ctx.createMediaElementSource(audio)
                    : ctx.createMediaStreamSource(audio);
        }
        this.audioConfigStateResolver(ctx, opts, audio);
        this.audioConfigStateParser(ctx);
    }
    waveform(output, channel) {
        if (!output) {
            output =
                this.wavedata ||
                    (this.wavedata = new Uint8Array((this.analyser[0] || this.analyser).frequencyBinCount));
        }
        const analyser = this.stereo ? this.analyser[channel || 0] : this.analyser;
        analyser.getByteTimeDomainData(output);
        return output;
    }
    frequencies(output, channel) {
        if (!output) {
            output =
                this.freqdata ||
                    (this.freqdata = new Uint8Array((this.analyser[0] || this.analyser).frequencyBinCount));
        }
        const analyser = this.stereo ? this.analyser[channel || 0] : this.analyser;
        analyser.getByteFrequencyData(output);
        return output;
    }
    audioConfigStateResolver(ctx, opts, audio) {
        this.analyser = ctx.createAnalyser();
        this.stereo = !!opts.stereo;
        this.audible = opts.audible !== false;
        this.wavedata = null;
        this.freqdata = null;
        this.splitter = null;
        this.merger = null;
        this.source = audio;
    }
    audioConfigStateParser(ctx) {
        if (!this.stereo) {
            this.output = this.source;
            this.source.connect(this.analyser[0] || this.analyser);
            if (this.audible) {
                (this.analyser[0] || this.analyser).connect(ctx.destination);
            }
        }
        else {
            this.analyser = [this.analyser[0] || this.analyser];
            this.analyser.push(ctx.createAnalyser());
            this.splitter = ctx.createChannelSplitter(2);
            this.merger = ctx.createChannelMerger(2);
            this.output = this.merger;
            this.source.connect(this.splitter);
            for (let i = 0; i < 2; i++) {
                this.splitter.connect(this.analyser[i], i, 0);
                this.analyser[i].connect(this.merger, 0, i);
            }
            if (this.audible) {
                this.merger.connect(ctx.destination);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtdmlkZW9ndWxhci9tb2R1bG8vc3JjL2xpYi91dGlscy9tb2R1bG8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBRTVFLE1BQU0sT0FBTyxPQUFPO0lBWWxCLFlBQ0UsS0FLOEIsRUFDOUIsR0FBd0IsRUFDeEIsSUFBOEM7UUFFOUMsSUFBSSxDQUFDLENBQUMsSUFBSSxZQUFZLE9BQU8sQ0FBQyxFQUFFO1lBQzlCLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN0QztRQUVELElBQUksQ0FBQyxDQUFDLEdBQUcsWUFBWSxZQUFZLENBQUMsRUFBRTtZQUNsQyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQztTQUM1QjtRQUVELElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsSUFBSSxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTNDLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxTQUFTLENBQUMsRUFBRTtZQUNqQyxLQUFLO2dCQUNILEtBQUssWUFBWSxLQUFLLElBQUksS0FBSyxZQUFZLGdCQUFnQjtvQkFDekQsQ0FBQyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUM7b0JBQ3JDLENBQUMsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDMUM7UUFFRCxJQUFJLENBQUMsd0JBQXdCLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRCxJ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QWMsRUFBRSxDQUFDLENBQUM7WUFFekMsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBRTFCLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVuQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDN0M7WUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN0QztTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtGbHVjdHVzSW50ZXJmYWNlfSBmcm9tICcuLi9pbnRlcmZhY2VzL2ZsdWN0dXMuaW50ZXJmYWNlJztcblxuY29uc3QgQXVkaW9Db250ZXh0ID0gd2luZG93W1wiQXVkaW9Db250ZXh0XCJdIHx8IHdpbmRvd1tcIndlYmtpdEF1ZGlvQ29udGV4dFwiXTtcblxuZXhwb3J0IGNsYXNzIEdvbmRvbG8gaW1wbGVtZW50cyBGbHVjdHVzSW50ZXJmYWNlIHtcbiAgY3R4OiBBdWRpb0NvbnRleHQ7XG4gIGFuYWx5c2VyOiBBbmFseXNlck5vZGUgfCBBcnJheTxBbmFseXNlck5vZGU+O1xuICBzdGVyZW86IGJvb2xlYW47XG4gIGF1ZGlibGU6IGJvb2xlYW47XG4gIHdhdmVkYXRhOiBVaW50OEFycmF5IHwgbnVsbDtcbiAgZnJlcWRhdGE6IGFueTtcbiAgc3BsaXR0ZXI6IENoYW5uZWxTcGxpdHRlck5vZGUgfCBudWxsO1xuICBtZXJnZXI6IENoYW5uZWxNZXJnZXJOb2RlIHwgbnVsbDtcbiAgc291cmNlOiBNZWRpYUVsZW1lbnRBdWRpb1NvdXJjZU5vZGUgfCBNZWRpYVN0cmVhbUF1ZGlvU291cmNlTm9kZTtcbiAgb3V0cHV0OiBDaGFubmVsTWVyZ2VyTm9kZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBhdWRpbzpcbiAgICAgIHwgSFRNTEF1ZGlvRWxlbWVudFxuICAgICAgfCBBdWRpb05vZGVcbiAgICAgIHwgTWVkaWFTdHJlYW1cbiAgICAgIHwgTWVkaWFFbGVtZW50QXVkaW9Tb3VyY2VOb2RlXG4gICAgICB8IE1lZGlhU3RyZWFtQXVkaW9Tb3VyY2VOb2RlLFxuICAgIGN0eD86IEF1ZGlvQ29udGV4dCB8IGFueSxcbiAgICBvcHRzPzogeyBzdGVyZW8/OiBib29sZWFuOyBhdWRpYmxlPzogYm9vbGVhbiB9XG4gICkge1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBHb25kb2xvKSkge1xuICAgICAgcmV0dXJuIG5ldyBHb25kb2xvKGF1ZGlvLCBjdHgsIG9wdHMpO1xuICAgIH1cblxuICAgIGlmICghKGN0eCBpbnN0YW5jZW9mIEF1ZGlvQ29udGV4dCkpIHtcbiAgICAgIChvcHRzID0gY3R4KSwgKGN0eCA9IG51bGwpO1xuICAgIH1cblxuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIHRoaXMuY3R4ID0gY3R4ID0gY3R4IHx8IG5ldyBBdWRpb0NvbnRleHQoKTtcblxuICAgIGlmICghKGF1ZGlvIGluc3RhbmNlb2YgQXVkaW9Ob2RlKSkge1xuICAgICAgYXVkaW8gPVxuICAgICAgICBhdWRpbyBpbnN0YW5jZW9mIEF1ZGlvIHx8IGF1ZGlvIGluc3RhbmNlb2YgSFRNTEF1ZGlvRWxlbWVudFxuICAgICAgICAgID8gY3R4LmNyZWF0ZU1lZGlhRWxlbWVudFNvdXJjZShhdWRpbylcbiAgICAgICAgICA6IGN0eC5jcmVhdGVNZWRpYVN0cmVhbVNvdXJjZShhdWRpbyk7XG4gICAgfVxuXG4gICAgdGhpcy5hdWRpb0NvbmZpZ1N0YXRlUmVzb2x2ZXIoY3R4LCBvcHRzLCBhdWRpbyk7XG4gICAgdGhpcy5hdWRpb0NvbmZpZ1N0YXRlUGFyc2VyKGN0eCk7XG4gIH1cblxuICBwdWJsaWMgd2F2ZWZvcm0ob3V0cHV0PzogVWludDhBcnJheSwgY2hhbm5lbD86IG51bWJlcik6IFVpbnQ4QXJyYXkge1xuICAgIGlmICghb3V0cHV0KSB7XG4gICAgICBvdXRwdXQgPVxuICAgICAgICB0aGlzLndhdmVkYXRhIHx8XG4gICAgICAgICh0aGlzLndhdmVkYXRhID0gbmV3IFVpbnQ4QXJyYXkoXG4gICAgICAgICAgKHRoaXMuYW5hbHlzZXJbMF0gfHwgdGhpcy5hbmFseXNlcikuZnJlcXVlbmN5QmluQ291bnRcbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgY29uc3QgYW5hbHlzZXIgPSB0aGlzLnN0ZXJlbyA/IHRoaXMuYW5hbHlzZXJbY2hhbm5lbCB8fCAwXSA6IHRoaXMuYW5hbHlzZXI7XG5cbiAgICBhbmFseXNlci5nZXRCeXRlVGltZURvbWFpbkRhdGEob3V0cHV0KTtcblxuICAgIHJldHVybiBvdXRwdXQ7XG4gIH1cblxuICBwdWJsaWMgZnJlcXVlbmNpZXMob3V0cHV0PzogVWludDhBcnJheSwgY2hhbm5lbD86IG51bWJlcik6IFVpbnQ4QXJyYXkge1xuICAgIGlmICghb3V0cHV0KSB7XG4gICAgICBvdXRwdXQgPVxuICAgICAgICB0aGlzLmZyZXFkYXRhIHx8XG4gICAgICAgICh0aGlzLmZyZXFkYXRhID0gbmV3IFVpbnQ4QXJyYXkoXG4gICAgICAgICAgKHRoaXMuYW5hbHlzZXJbMF0gfHwgdGhpcy5hbmFseXNlcikuZnJlcXVlbmN5QmluQ291bnRcbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgY29uc3QgYW5hbHlzZXIgPSB0aGlzLnN0ZXJlbyA/IHRoaXMuYW5hbHlzZXJbY2hhbm5lbCB8fCAwXSA6IHRoaXMuYW5hbHlzZXI7XG5cbiAgICBhbmFseXNlci5nZXRCeXRlRnJlcXVlbmN5RGF0YShvdXRwdXQpO1xuXG4gICAgcmV0dXJuIG91dHB1dDtcbiAgfVxuXG4gIHByaXZhdGUgYXVkaW9Db25maWdTdGF0ZVJlc29sdmVyKFxuICAgIGN0eDogQXVkaW9Db250ZXh0LFxuICAgIG9wdHM6IHsgc3RlcmVvPzogYm9vbGVhbjsgYXVkaWJsZT86IGJvb2xlYW4gfSxcbiAgICBhdWRpbzogTWVkaWFFbGVtZW50QXVkaW9Tb3VyY2VOb2RlIHwgYW55XG4gICk6IHZvaWQge1xuICAgIHRoaXMuYW5hbHlzZXIgPSBjdHguY3JlYXRlQW5hbHlzZXIoKTtcbiAgICB0aGlzLnN0ZXJlbyA9ICEhb3B0cy5zdGVyZW87XG4gICAgdGhpcy5hdWRpYmxlID0gb3B0cy5hdWRpYmxlICE9PSBmYWxzZTtcbiAgICB0aGlzLndhdmVkYXRhID0gbnVsbDtcbiAgICB0aGlzLmZyZXFkYXRhID0gbnVsbDtcbiAgICB0aGlzLnNwbGl0dGVyID0gbnVsbDtcbiAgICB0aGlzLm1lcmdlciA9IG51bGw7XG4gICAgdGhpcy5zb3VyY2UgPSBhdWRpbztcbiAgfVxuXG4gIHByaXZhdGUgYXVkaW9Db25maWdTdGF0ZVBhcnNlcihjdHg6IEF1ZGlvQ29udGV4dCkge1xuICAgIGlmICghdGhpcy5zdGVyZW8pIHtcbiAgICAgIHRoaXMub3V0cHV0ID0gdGhpcy5zb3VyY2U7XG5cbiAgICAgIHRoaXMuc291cmNlLmNvbm5lY3QodGhpcy5hbmFseXNlclswXSB8fCB0aGlzLmFuYWx5c2VyKTtcblxuICAgICAgaWYgKHRoaXMuYXVkaWJsZSkge1xuICAgICAgICAodGhpcy5hbmFseXNlclswXSB8fCB0aGlzLmFuYWx5c2VyKS5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYW5hbHlzZXIgPSBbdGhpcy5hbmFseXNlclswXSB8fCB0aGlzLmFuYWx5c2VyXTtcblxuICAgICAgdGhpcy5hbmFseXNlci5wdXNoKGN0eC5jcmVhdGVBbmFseXNlcigpKTtcblxuICAgICAgdGhpcy5zcGxpdHRlciA9IGN0eC5jcmVhdGVDaGFubmVsU3BsaXR0ZXIoMik7XG4gICAgICB0aGlzLm1lcmdlciA9IGN0eC5jcmVhdGVDaGFubmVsTWVyZ2VyKDIpO1xuICAgICAgdGhpcy5vdXRwdXQgPSB0aGlzLm1lcmdlcjtcblxuICAgICAgdGhpcy5zb3VyY2UuY29ubmVjdCh0aGlzLnNwbGl0dGVyKTtcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyBpKyspIHtcbiAgICAgICAgdGhpcy5zcGxpdHRlci5jb25uZWN0KHRoaXMuYW5hbHlzZXJbaV0sIGksIDApO1xuICAgICAgICB0aGlzLmFuYWx5c2VyW2ldLmNvbm5lY3QodGhpcy5tZXJnZXIsIDAsIGkpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5hdWRpYmxlKSB7XG4gICAgICAgIHRoaXMubWVyZ2VyLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==