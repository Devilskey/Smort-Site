import { Directive, Input, Output, EventEmitter, ElementRef, } from '@angular/core';
import { VgApiService, } from '@videogular/ngx-videogular/core';
import * as i0 from "@angular/core";
import * as i1 from "@videogular/ngx-videogular/core";
class VgDashDirective {
    constructor(ref, API) {
        this.ref = ref;
        this.API = API;
        this.onGetBitrates = new EventEmitter();
        this.subscriptions = [];
    }
    ngOnInit() {
        if (this.API.isPlayerReady) {
            this.onPlayerReady();
        }
        else {
            this.subscriptions.push(this.API.playerReadyEvent.subscribe(() => this.onPlayerReady()));
        }
    }
    onPlayerReady() {
        this.vgFor = this.ref.nativeElement.getAttribute('vgFor');
        this.target = this.API.getMediaById(this.vgFor);
        this.createPlayer();
    }
    ngOnChanges(changes) {
        changes.vgDash?.currentValue ? this.createPlayer() : this.destroyPlayer();
    }
    createPlayer() {
        if (this.dash) {
            this.destroyPlayer();
        }
        // It's a DASH source
        if (this.vgDash &&
            (this.vgDash.indexOf('.mpd') > -1 ||
                this.vgDash.indexOf('mpd-time-csf') > -1)) {
            let drmOptions;
            if (this.vgDRMLicenseServer) {
                drmOptions = this.vgDRMLicenseServer;
                if (this.vgDRMToken) {
                    for (const drmServer in drmOptions) {
                        if (drmServer.hasOwnProperty(drmServer)) {
                            drmOptions[drmServer].httpRequestHeaders = {
                                Authorization: this.vgDRMToken,
                            };
                        }
                    }
                }
            }
            this.dash = dashjs.MediaPlayer().create();
            this.dash.updateSettings({ debug: { logLevel: dashjs.Debug.LOG_LEVEL_NONE } });
            this.dash.initialize(this.ref.nativeElement);
            this.dash.setAutoPlay(false);
            this.dash.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                const audioList = this.dash.getBitrateInfoListFor('audio');
                const videoList = this.dash.getBitrateInfoListFor('video');
                if (audioList.length > 1) {
                    audioList.forEach((item) => (item.qualityIndex = ++item.qualityIndex));
                    audioList.unshift({
                        qualityIndex: 0,
                        width: 0,
                        height: 0,
                        bitrate: 0,
                        mediaType: 'video',
                        scanType: 'AUTO',
                    });
                    this.onGetBitrates.emit(audioList);
                }
                if (videoList.length > 1) {
                    videoList.forEach((item) => (item.qualityIndex = ++item.qualityIndex));
                    videoList.unshift({
                        qualityIndex: 0,
                        width: 0,
                        height: 0,
                        bitrate: 0,
                        mediaType: 'video',
                        scanType: 'AUTO',
                    });
                    this.onGetBitrates.emit(videoList);
                }
            });
            if (drmOptions) {
                this.dash.setProtectionData(drmOptions);
            }
            this.dash.attachSource(this.vgDash);
        }
        else {
            if (this.target) {
                this.target.pause();
                this.target.seekTime(0);
                this.ref.nativeElement.src = this.vgDash;
            }
        }
    }
    setBitrate({ mediaType, qualityIndex }) {
        if (this.dash) {
            if (qualityIndex > 0) {
                if (this.dash.getSettings()) {
                    this.dash.updateSettings({
                        streaming: {
                            abr: {
                                autoSwitchBitrate: {
                                    [mediaType]: false
                                }
                            }
                        }
                    });
                }
                const nextIndex = qualityIndex - 1;
                this.dash.setQualityFor(mediaType, nextIndex);
            }
            else {
                this.dash.updateSettings({
                    streaming: {
                        abr: {
                            autoSwitchBitrate: {
                                [mediaType]: true
                            }
                        }
                    }
                });
            }
        }
    }
    destroyPlayer() {
        if (this.dash) {
            this.dash.reset();
            this.dash = null;
        }
    }
    ngOnDestroy() {
        this.subscriptions.forEach((s) => s.unsubscribe());
        this.destroyPlayer();
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: VgDashDirective, deps: [{ token: i0.ElementRef }, { token: i1.VgApiService }], target: i0.ɵɵFactoryTarget.Directive }); }
    /** @nocollapse */ static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.0.1", type: VgDashDirective, selector: "[vgDash]", inputs: { vgDash: "vgDash", vgDRMToken: "vgDRMToken", vgDRMLicenseServer: "vgDRMLicenseServer" }, outputs: { onGetBitrates: "onGetBitrates" }, exportAs: ["vgDash"], usesOnChanges: true, ngImport: i0 }); }
}
export { VgDashDirective };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.1", ngImport: i0, type: VgDashDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[vgDash]',
                    exportAs: 'vgDash',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.VgApiService }]; }, propDecorators: { vgDash: [{
                type: Input
            }], vgDRMToken: [{
                type: Input
            }], vgDRMLicenseServer: [{
                type: Input
            }], onGetBitrates: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmctZGFzaC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL25neC12aWRlb2d1bGFyL3N0cmVhbWluZy9zcmMvbGliL2RpcmVjdGl2ZXMvdmctZGFzaC92Zy1kYXNoLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUlULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFVBQVUsR0FFWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBR0wsWUFBWSxHQUNiLE1BQU0saUNBQWlDLENBQUM7OztBQVV6QyxNQUlhLGVBQWU7SUFhMUIsWUFBb0IsR0FBZSxFQUFTLEdBQWlCO1FBQXpDLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFBUyxRQUFHLEdBQUgsR0FBRyxDQUFjO1FBUm5ELGtCQUFhLEdBQW1DLElBQUksWUFBWSxFQUFFLENBQUM7UUFNN0Usa0JBQWEsR0FBbUIsRUFBRSxDQUFDO0lBRTZCLENBQUM7SUFFakUsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3RCO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQ2hFLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRCxhQUFhO1FBQ1gsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENB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Q0FDbkI7NkJBQ0Y7eUJBQ0Y7cUJBQ0YsQ0FBQyxDQUFDO2lCQUNKO2dCQUVELE1BQU0sU0FBUyxHQUFHLFlBQVksR0FBRyxDQUFDLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUMvQztpQkFBTTtnQkFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztvQkFDdkIsU0FBUyxFQUFFO3dCQUNULEdBQUcsRUFBRTs0QkFDSCxpQkFBaUIsRUFBRTtnQ0FDakIsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJOzZCQUNsQjt5QkFDRjtxQkFDRjtpQkFDRixDQUFDLENBQUM7YUFDSjtTQUNGO0lBQ0gsQ0FBQztJQUVELGFBQWE7UUFDWCxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDYixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2xCO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7aUlBbEtVLGVBQWU7cUhBQWYsZUFBZTs7U0FBZixlQUFlOzJGQUFmLGVBQWU7a0JBSjNCLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLFVBQVU7b0JBQ3BCLFFBQVEsRUFBRSxRQUFRO2lCQUNuQjs0SEFFVSxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csVUFBVTtzQkFBbEIsS0FBSztnQkFDRyxrQkFBa0I7c0JBQTFCLEtBQUs7Z0JBRUksYUFBYTtzQkFBdEIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgT25Jbml0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBFbGVtZW50UmVmLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgSURSTUxpY2Vuc2VTZXJ2ZXIsXG4gIEJpdHJhdGVPcHRpb25zLFxuICBWZ0FwaVNlcnZpY2UsXG59IGZyb20gJ0B2aWRlb2d1bGFyL25neC12aWRlb2d1bGFyL2NvcmUnO1xuXG5kZWNsYXJlIGxldCBkYXNoanM6IHtcbiAgTWVkaWFQbGF5ZXI6IHtcbiAgICAoKTogeyAoKTogYW55OyBuZXcgKCk6IGFueTsgY3JlYXRlOiB7ICgpOiBhbnk7IG5ldyAoKTogYW55IH0gfTtcbiAgICBldmVudHM6IHsgU1RSRUFNX0lOSVRJQUxJWkVEOiBhbnkgfTtcbiAgfTtcbiAgRGVidWc6IHsgTE9HX0xFVkVMX05PTkU6IGFueSB9O1xufTtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW3ZnRGFzaF0nLFxuICBleHBvcnRBczogJ3ZnRGFzaCcsXG59KVxuZXhwb3J0IGNsYXNzIFZnRGFzaERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSB2Z0Rhc2g6IHN0cmluZztcbiAgQElucHV0KCkgdmdEUk1Ub2tlbjogc3RyaW5nO1xuICBASW5wdXQoKSB2Z0RSTUxpY2Vuc2VTZXJ2ZXI6IElEUk1MaWNlbnNlU2VydmVyO1xuXG4gIEBPdXRwdXQoKSBvbkdldEJpdHJhdGVzOiBFdmVudEVtaXR0ZXI8Qml0cmF0ZU9wdGlvbnNbXT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgdmdGb3I6IHN0cmluZztcbiAgdGFyZ2V0OiBhbnk7XG4gIGRhc2g6IGFueTtcblxuICBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVmOiBFbGVtZW50UmVmLCBwdWJsaWMgQVBJOiBWZ0FwaVNlcnZpY2UpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKHRoaXMuQVBJLmlzUGxheWVyUmVhZHkpIHtcbiAgICAgIHRoaXMub25QbGF5ZXJSZWFkeSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICAgdGhpcy5BUEkucGxheWVyUmVhZHlFdmVudC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5vblBsYXllclJlYWR5KCkpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG9uUGxheWVyUmVhZHkoKSB7XG4gICAgdGhpcy52Z0ZvciA9IHRoaXMucmVmLm5hdGl2ZUVsZW1lbnQuZ2V0QXR0cmlidXRlKCd2Z0ZvcicpO1xuICAgIHRoaXMudGFyZ2V0ID0gdGhpcy5BUEkuZ2V0TWVkaWFCeUlkKHRoaXMudmdGb3IpO1xuICAgIHRoaXMuY3JlYXRlUGxheWVyKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgY2hhbmdlcy52Z0Rhc2g/LmN1cnJlbnRWYWx1ZSA/IHRoaXMuY3JlYXRlUGxheWVyKCkgOiB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgfVxuXG4gIGNyZWF0ZVBsYXllcigpIHtcbiAgICBpZiAodGhpcy5kYXNoKSB7XG4gICAgICB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgICB9XG5cbiAgICAvLyBJdCdzIGEgREFTSCBzb3VyY2VcbiAgICBpZiAoXG4gICAgICB0aGlzLnZnRGFzaCAmJlxuICAgICAgKHRoaXMudmdEYXNoLmluZGV4T2YoJy5tcGQnKSA+IC0xIHx8XG4gICAgICAgIHRoaXMudmdEYXNoLmluZGV4T2YoJ21wZC10aW1lLWNzZicpID4gLTEpXG4gICAgKSB7XG4gICAgICBsZXQgZHJtT3B0aW9uczogYW55O1xuXG4gICAgICBpZiAodGhpcy52Z0RSTUxpY2Vuc2VTZXJ2ZXIpIHtcbiAgICAgICAgZHJtT3B0aW9ucyA9IHRoaXMudmdEUk1MaWNlbnNlU2VydmVyO1xuXG4gICAgICAgIGlmICh0aGlzLnZnRFJNVG9rZW4pIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGRybVNlcnZlciBpbiBkcm1PcHRpb25zKSB7XG4gICAgICAgICAgICBpZiAoZHJtU2VydmVyLmhhc093blByb3BlcnR5KGRybVNlcnZlcikpIHtcbiAgICAgICAgICAgICAgZHJtT3B0aW9uc1tkcm1TZXJ2ZXJdLmh0dHBSZXF1ZXN0SGVhZGVycyA9IHtcbiAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiB0aGlzLnZnRFJNVG9rZW4sXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZGFzaCA9IGRhc2hqcy5NZWRpYVBsYXllcigpLmNyZWF0ZSgpO1xuICAgICAgdGhpcy5kYXNoLnVwZGF0ZVNldHRpbmdzKHtkZWJ1Zzoge2xvZ0xldmVsOiBkYXNoanMuRGVidWcuTE9HX0xFVkVMX05PTkV9fSk7XG4gICAgICB0aGlzLmRhc2guaW5pdGlhbGl6ZSh0aGlzLnJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICAgIHRoaXMuZGFzaC5zZXRBdXRvUGxheShmYWxzZSk7XG5cbiAgICAgIHRoaXMuZGFzaC5vbihkYXNoanMuTWVkaWFQbGF5ZXIuZXZlbnRzLlNUUkVBTV9JTklUSUFMSVpFRCwgKCkgPT4ge1xuICAgICAgICBjb25zdCBhdWRpb0xpc3QgPSB0aGlzLmRhc2guZ2V0Qml0cmF0ZUluZm9MaXN0Rm9yKCdhdWRpbycpO1xuICAgICAgICBjb25zdCB2aWRlb0xpc3QgPSB0aGlzLmRhc2guZ2V0Qml0cmF0ZUluZm9MaXN0Rm9yKCd2aWRlbycpO1xuXG4gICAgICAgIGlmIChhdWRpb0xpc3QubGVuZ3RoID4gMSkge1xuICAgICAgICAgIGF1ZGlvTGlzdC5mb3JFYWNoKFxuICAgICAgICAgICAgKGl0ZW06IHsgcXVhbGl0eUluZGV4OiBudW1iZXIgfSkgPT5cbiAgICAgICAgICAgICAgKGl0ZW0ucXVhbGl0eUluZGV4ID0gKytpdGVtLnF1YWxpdHlJbmRleClcbiAgICAgICAgICApO1xuICAgICAgICAgIGF1ZGlvTGlzdC51bnNoaWZ0KHtcbiAgICAgICAgICAgIHF1YWxpdHlJbmRleDogMCxcbiAgICAgICAgICAgIHdpZHRoOiAwLFxuICAgICAgICAgICAgaGVpZ2h0OiAwLFxuICAgICAgICAgICAgYml0cmF0ZTogMCxcbiAgICAgICAgICAgIG1lZGlhVHlwZTogJ3ZpZGVvJyxcbiAgICAgICAgICAgIHNjYW5UeXBlOiAnQVVUTycsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB0aGlzLm9uR2V0Qml0cmF0ZXMuZW1pdChhdWRpb0xpc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHZpZGVvTGlzdC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgdmlkZW9MaXN0LmZvckVhY2goXG4gICAgICAgICAgICAoaXRlbToge3F1YWxpdHlJbmRleDogbnVtYmVyfSkgPT4gKFxuICAgICAgICAgICAgICBpdGVtLnF1YWxpdHlJbmRleCA9ICsraXRlbS5xdWFsaXR5SW5kZXhcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuICAgICAgICAgIHZpZGVvTGlzdC51bnNoaWZ0KHtcbiAgICAgICAgICAgIHF1YWxpdHlJbmRleDogMCxcbiAgICAgICAgICAgIHdpZHRoOiAwLFxuICAgICAgICAgICAgaGVpZ2h0OiAwLFxuICAgICAgICAgICAgYml0cmF0ZTogMCxcbiAgICAgICAgICAgIG1lZGlhVHlwZTogJ3ZpZGVvJyxcbiAgICAgICAgICAgIHNjYW5UeXBlOiAnQVVUTycsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB0aGlzLm9uR2V0Qml0cmF0ZXMuZW1pdCh2aWRlb0xpc3QpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaWYgKGRybU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5kYXNoLnNldFByb3RlY3Rpb25EYXRhKGRybU9wdGlvbnMpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmRhc2guYXR0YWNoU291cmNlKHRoaXMudmdEYXNoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMudGFyZ2V0KSB7XG4gICAgICAgIHRoaXMudGFyZ2V0LnBhdXNlKCk7XG4gICAgICAgIHRoaXMudGFyZ2V0LnNlZWtUaW1lKDApO1xuICAgICAgICB0aGlzLnJlZi5uYXRpdmVFbGVtZW50LnNyYyA9IHRoaXMudmdEYXNoO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldEJpdHJhdGUoe21lZGlhVHlwZSwgcXVhbGl0eUluZGV4fTogQml0cmF0ZU9wdGlvbnMpIHtcbiAgICBpZiAodGhpcy5kYXNoKSB7XG4gICAgICBpZiAocXVhbGl0eUluZGV4ID4gMCkge1xuICAgICAgICBpZiAodGhpcy5kYXNoLmdldFNldHRpbmdzKCkpIHtcbiAgICAgICAgICB0aGlzLmRhc2gudXBkYXRlU2V0dGluZ3Moe1xuICAgICAgICAgICAgc3RyZWFtaW5nOiB7XG4gICAgICAgICAgICAgIGFicjoge1xuICAgICAgICAgICAgICAgIGF1dG9Td2l0Y2hCaXRyYXRlOiB7XG4gICAgICAgICAgICAgICAgICBbbWVkaWFUeXBlXTogZmFsc2VcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5leHRJbmRleCA9IHF1YWxpdHlJbmRleCAtIDE7XG4gICAgICAgIHRoaXMuZGFzaC5zZXRRdWFsaXR5Rm9yKG1lZGlhVHlwZSwgbmV4dEluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZGFzaC51cGRhdGVTZXR0aW5ncyh7XG4gICAgICAgICAgc3RyZWFtaW5nOiB7XG4gICAgICAgICAgICBhYnI6IHtcbiAgICAgICAgICAgICAgYXV0b1N3aXRjaEJpdHJhdGU6IHtcbiAgICAgICAgICAgICAgICBbbWVkaWFUeXBlXTogdHJ1ZVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBkZXN0cm95UGxheWVyKCkge1xuICAgIGlmICh0aGlzLmRhc2gpIHtcbiAgICAgIHRoaXMuZGFzaC5yZXNldCgpO1xuICAgICAgdGhpcy5kYXNoID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaCgocykgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgICB0aGlzLmRlc3Ryb3lQbGF5ZXIoKTtcbiAgfVxufVxuIl19